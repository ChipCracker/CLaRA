#!/usr/bin/env bash
set -euo pipefail

# Determine project root relative to this script
# Assuming script is in <root>/hooks/
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    echo "[clara] Error: docker command not found. Cannot run pre-commit checks."
    exit 1
fi

# 1. Identify staged .tex and .bib files
# We use diff --cached to get files staged for commit
# --name-only: just filenames
# --diff-filter=ACM: Added, Copied, Modified (exclude deleted)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tex|bib)$' || true)

if [ -z "$STAGED_FILES" ]; then
    # No LaTeX files changed, skip checks
    exit 0
fi

echo "[clara] Running pre-commit checks on staged files:"
echo "$STAGED_FILES"

# 2. Run checks inside Docker
# We use 'make check' but pass specific files if possible?
# Our CLI supports --files. 'make check' in Makefile currently runs on all/default.
# Let's invoke docker compose run directly for precision.
# Note: Paths in STAGED_FILES are relative to git root, which matches docker workdir structure.

# We redirect stdout to a temp file to parse it or just show it on error
TEMP_OUT=$(mktemp)

# Use 'python -m clara.cli check --fast --json ... --files ...'
# We don't use LLM in pre-commit (too slow), only fast checks.
# We mount the current directory to ensure we see the staged changes? 
# NO: Docker sees files on disk. Git pre-commit usually checks what is *staged*.
# If user staged changes but file on disk has unstaged changes, Docker sees disk version.
# This is a known limitation of docker-based hooks. 
# Advanced solution: 'git checkout-index' to temp dir and mount that. 
# For MVP/Student project: checking disk version is usually acceptable, 
# or we warn user "Stash unstaged changes first".

set +e
# Run check and if it fails, use jq to print a summary from the JSON output
docker compose run --rm -T core bash -c "python -m clara.cli check --fast --json out/commit_check.json --files $STAGED_FILES || (echo '--- Report ---' && cat out/commit_check.json | python -m json.tool && exit 1)" > "$TEMP_OUT" 2>&1
EXIT_CODE=$?
set -e

# 3. Handle Result
if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "❌ [clara] Checks failed. Please fix the issues below before committing."
    echo "---------------------------------------------------------------------"
    cat "$TEMP_OUT"
    echo "---------------------------------------------------------------------"
    echo "Tip: Run 'make fix' to auto-format or 'make fix-content' for AI help."
    rm -f "$TEMP_OUT"
    exit 1
fi

echo "✅ [clara] All checks passed."
rm -f "$TEMP_OUT"
exit 0
